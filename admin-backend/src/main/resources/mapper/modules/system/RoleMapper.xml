<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.backend.modules.system.mapper.RoleMapper">

    <!-- 获取指定角色 roleId 的所有上级角色信息 -->
    <select id="getAllAncestorByRoleId" resultType="com.example.backend.modules.system.mapper.dto.DbResultAncestorRole">
        WITH RECURSIVE role_ancestors AS (
            SELECT
                id,
                role_name,
                parent_id,
                level,
                0 AS deps,
                CAST(id AS CHAR(1000)) AS path  -- 初始化路径，记录已访问的节点ID
            FROM system_role
            WHERE id = #{roleId}  -- 指定起始角色ID

            UNION ALL

            SELECT
                r.id,
                r.role_name,
                r.parent_id,
                r.level,
                ra.deps + 1,
                CAST(CONCAT(ra.path, ',', r.id) AS CHAR(1000))  -- 将当前节点ID加入路径
            FROM system_role r
            INNER JOIN role_ancestors ra ON r.id = ra.parent_id
            WHERE FIND_IN_SET(r.id, ra.path) = 0  -- 关键防环条件：检查新节点是否已在路径中
        )
        SELECT * FROM role_ancestors;
    </select>

    <!-- 获取一批指定角色 roleId 的所有上级角色信息 -->
    <!-- 此查询包含 root_id (也就是传入需要查询的 roleIdList 中的)，但是可能会有重复项（比如 1 <- 2 <- 3 这个树，查询 [2,3]，那么会按顺序返回 2,1,3,2,1 5条记录） -->
    <select id="getAllAncestorByRoleIdList" resultType="com.example.backend.modules.system.mapper.dto.DbResultAncestorRole">
        WITH RECURSIVE role_ancestors AS (
            SELECT
                id,
                role_name,
                parent_id,
                level,
                0 AS deps,
                CAST(id AS CHAR(1000)) AS path,  <!-- 初始化路径，记录已访问的节点ID -->
                id as root_id  <!-- 记录初始角色ID -->
            FROM system_role
            WHERE id IN
                <foreach item="item" collection="roleIdList" open="(" separator="," close=")">
                    #{item}
                </foreach>

            UNION ALL

            SELECT
                r.id,
                r.role_name,
                r.parent_id,
                r.level,
                ra.deps + 1,
                CAST(CONCAT(ra.path, ',', r.id) AS CHAR(1000)),  <!-- 将当前节点ID加入路径 -->
                ra.root_id  <!-- 递归过程中，root_id保持不变 -->
            FROM system_role r
            INNER JOIN role_ancestors ra ON r.id = ra.parent_id
            WHERE FIND_IN_SET(r.id, ra.path) = 0  <!-- 防环条件 -->
        )
        SELECT <!-- * -->
        <if test="distinctResult == true">distinct</if>
        id, role_name, parent_id
        FROM role_ancestors
    </select>

    <select id="getSystemRolePage" parameterType="map" resultType="com.example.backend.modules.system.model.entity.Role">
        <include refid="getRoleListFragment" />
    </select>
    <select id="getSystemRoleList" parameterType="map" resultType="com.example.backend.modules.system.model.entity.Role">
        <include refid="getRoleListFragment" />
    </select>
    <sql id="getRoleListFragment">
        SELECT * FROM system_role
        <where>
            <if test="query.id != null">
                AND id = #{query.id}
            </if>
            <if test="query.roleName != null and query.roleName != ''">
                AND role_name LIKE concat('%',#{query.roleName},'%')
            </if>
        </where>
    </sql>

</mapper>
